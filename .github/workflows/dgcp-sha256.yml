name: DGCP SHA-256 (auto + backfill)

on:
  # Auto mode: runs when new/updated dataunit JSON is pushed
  push:
    paths:
      - "dataset/data-unit/**/dataunit_*.json"
    paths-ignore:
      - "dataset/data-unit/**/hash/**"

  # Manual mode: allow backfill run from Actions tab
  workflow_dispatch:
    inputs:
      mode:
        description: "Choose run mode"
        required: true
        default: "backfill"
        type: choice
        options:
          - backfill
          - auto_only

permissions:
  contents: write

jobs:
  sha256:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Decide run mode
        id: mode
        shell: bash
        run: |
          set -euo pipefail
          # If manual dispatch: use selected mode
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "mode=${{ inputs.mode }}" >> "$GITHUB_OUTPUT"
          else
            # If push event: always auto_only
            echo "mode=auto_only" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate SHA-256 sidecar files
        id: gen
        shell: bash
        run: |
          set -euo pipefail

          MODE="${{ steps.mode.outputs.mode }}"
          changed=0

          # Helper: write sha sidecar for a given dataunit json
          write_sha () {
            local f="$1"
            local base id unit_dir sha_dir sha_file sha content

            base="$(basename "$f")"        # dataunit_00001.json
            id="${base#dataunit_}"         # 00001.json
            id="${id%.json}"               # 00001

            unit_dir="$(dirname "$f")"     # dataset/data-unit/00001
            sha_dir="${unit_dir}/hash"
            sha_file="${sha_dir}/dataunit_${id}.sha256"

            mkdir -p "$sha_dir"

            sha="$(sha256sum "$f" | awk '{print $1}')"

            content="SHA-256: ${sha}
FILE: ${f}
"

            if [ ! -f "$sha_file" ] || [ "$(cat "$sha_file")" != "$content" ]; then
              printf "%s" "$content" > "$sha_file"
              changed=1
              echo "updated: $sha_file"
            fi
          }

          if [ "$MODE" = "backfill" ]; then
            # Backfill: process ALL dataunit JSON files
            while IFS= read -r f; do
              write_sha "$f"
            done < <(find dataset/data-unit -type f -name "dataunit_*.json" | sort)

          else
            # Auto only: process only JSON files changed in the last commit range
            # Fallback to all if git diff fails (rare)
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              mapfile -t files < <(git diff --name-only HEAD^..HEAD -- 'dataset/data-unit/**/dataunit_*.json' | sort)
              if [ "${#files[@]}" -eq 0 ]; then
                echo "No dataunit JSON changes detected in last commit range."
              else
                for f in "${files[@]}"; do
                  # ensure file exists in workspace
                  if [ -f "$f" ]; then
                    write_sha "$f"
                  fi
                done
              fi
            else
              # First commit in repo (unlikely)
              while IFS= read -r f; do
                write_sha "$f"
              done < <(find dataset/data-unit -type f -name "dataunit_*.json" | sort)
            fi
          fi

          echo "changed=$changed" >> "$GITHUB_OUTPUT"

      - name: Commit & push SHA files
        if: ${{ steps.gen.outputs.changed == '1' }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "dgcp-bot"
          git config user.email "dgcp-bot@users.noreply.github.com"

          git add dataset/data-unit/**/hash/dataunit_*.sha256

          git commit -m "add: sha256 sidecars for data units [skip ci]" \
                     -m "DGCP automation: generate/refresh SHA-256 sidecar files under dataset/data-unit/<id>/hash/ for each dataunit_*.json. JSON files are not modified."

          git push
