name: DGCP SHA-256 (auto + backfill)

on:
  push:
    paths:
      - "dataset/data-unit/**/dataunit_*.json"
    paths-ignore:
      - "dataset/data-unit/**/hash/**"

  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode"
        required: true
        default: "backfill"
        type: choice
        options:
          - backfill
          - auto_only

permissions:
  contents: write

jobs:
  sha256:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set run mode
        id: setmode
        run: |
          if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            echo "MODE=${{ inputs.mode }}" >> $GITHUB_ENV
          else
            echo "MODE=auto_only" >> $GITHUB_ENV
          fi

      - name: Generate SHA-256 files
        run: |
          set -e

          changed=0

          write_sha () {
            f="$1"
            base="$(basename "$f")"
            id="${base#dataunit_}"
            id="${id%.json}"

            unit_dir="$(dirname "$f")"
            sha_dir="${unit_dir}/hash"
            sha_file="${sha_dir}/dataunit_${id}.sha256"

            mkdir -p "$sha_dir"

            sha="$(sha256sum "$f" | awk '{print $1}')"

            printf "SHA-256: %s\nFILE: %s\n" "$sha" "$f" > "$sha_file"
            changed=1
          }

          if [ "$MODE" = "backfill" ]; then
            find dataset/data-unit -type f -name "dataunit_*.json" | sort | while read f; do
              write_sha "$f"
            done
          else
            git diff --name-only HEAD^..HEAD -- 'dataset/data-unit/**/dataunit_*.json' | while read f; do
              [ -f "$f" ] && write_sha "$f"
            done
          fi

      - name: Commit and push SHA files
        run: |
          git config user.name "dgcp-bot"
          git config user.email "dgcp-bot@users.noreply.github.com"
          git add dataset/data-unit/**/hash/dataunit_*.sha256 || true
          git commit -m "add: sha256 sidecars for data units [skip ci]" || echo "No changes"
          git push
